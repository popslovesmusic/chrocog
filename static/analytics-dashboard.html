<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soundlab Analytics Dashboard - Feature 015</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
        }

        .section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            color: #ffff00;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        button {
            background: #1a4d1a;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }

        button:hover {
            background: #00ff00;
            color: #0a0a0a;
            box-shadow: 0 0 10px #00ff00;
        }

        button:disabled {
            background: #2a2a2a;
            color: #555;
            border-color: #555;
            cursor: not-allowed;
        }

        select, input {
            background: #2a2a2a;
            color: #00ff00;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 5px;
            font-family: inherit;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #333;
            padding: 10px;
            text-align: left;
        }

        th {
            background: #2a2a2a;
            color: #ffff00;
        }

        tr:hover {
            background: #252525;
        }

        .metric-value {
            font-weight: bold;
            color: #00ffff;
        }

        .positive {
            color: #00ff00;
        }

        .negative {
            color: #ff4444;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #444;
        }

        .stat-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            color: #00ffff;
        }

        #heatmapCanvas {
            border: 1px solid #333;
            margin-top: 15px;
            background: #1a1a1a;
        }

        .loading {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        .error {
            background: #4a1a1a;
            color: #ff4444;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ff4444;
            margin: 10px 0;
        }

        .success {
            background: #1a4a1a;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #00ff00;
            margin: 10px 0;
        }

        .session-item {
            background: #252525;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #00ff00;
            cursor: pointer;
            transition: all 0.3s;
        }

        .session-item:hover {
            background: #2a2a2a;
            border-left-color: #00ffff;
        }

        .session-item.selected {
            border-left-color: #ffff00;
            background: #3a3a2a;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .correlation-value {
            font-weight: bold;
        }

        .correlation-high {
            color: #00ff00;
        }

        .correlation-medium {
            color: #ffff00;
        }

        .correlation-low {
            color: #ff9900;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Soundlab Analytics Dashboard</h1>
        <p style="text-align: center; color: #888; margin-bottom: 30px;">
            Feature 015: Multi-Session Comparative Analytics
        </p>

        <!-- Session Management Section -->
        <div class="section">
            <div class="section-title">Session Management</div>

            <div class="controls">
                <button onclick="loadAvailableSessions()">Refresh Sessions</button>
                <select id="sessionSelect">
                    <option value="">Select session to load...</option>
                </select>
                <button onclick="loadSelectedSession()">Load Session</button>
            </div>

            <div id="sessionStatus"></div>

            <div id="loadedSessionsList"></div>
        </div>

        <!-- Session Statistics Section -->
        <div class="section">
            <div class="section-title">Loaded Sessions Statistics</div>

            <div id="sessionStats" class="loading">No sessions loaded</div>
        </div>

        <!-- Session Comparison Section -->
        <div class="section">
            <div class="section-title">Session Comparison</div>

            <div class="controls">
                <select id="sessionA">
                    <option value="">Select Session A...</option>
                </select>
                <select id="sessionB">
                    <option value="">Select Session B...</option>
                </select>
                <button onclick="compareSessions()">Compare Sessions</button>
            </div>

            <div id="comparisonResults"></div>
        </div>

        <!-- Correlation Analysis Section -->
        <div class="section">
            <div class="section-title">Correlation Analysis</div>

            <div class="controls">
                <select id="metricSelect">
                    <option value="ici">ICI</option>
                    <option value="coherence">Coherence</option>
                    <option value="criticality">Criticality</option>
                    <option value="phi">Phi</option>
                </select>
                <button onclick="loadCorrelationMatrix()">Load Correlation Matrix</button>
                <button onclick="loadAllCorrelations()">Load All Metrics</button>
            </div>

            <div id="correlationStatus"></div>

            <canvas id="heatmapCanvas" width="600" height="600"></canvas>
        </div>

        <!-- Memory Usage Section -->
        <div class="section">
            <div class="section-title">System Status</div>

            <div class="grid">
                <div class="stat-card">
                    <div class="stat-label">Loaded Sessions</div>
                    <div class="stat-value" id="loadedCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Samples</div>
                    <div class="stat-value" id="totalSamples">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Memory Usage (MB)</div>
                    <div class="stat-value" id="memoryUsage">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">SC-001 Status</div>
                    <div class="stat-value" id="sc001Status">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let loadedSessions = [];
        let availableSessions = [];

        // Initialize
        window.onload = () => {
            loadAvailableSessions();
            updateLoadedSessions();
            // Auto-refresh every 5 seconds
            setInterval(updateLoadedSessions, 5000);
        };

        // Load available sessions from server
        async function loadAvailableSessions() {
            try {
                const response = await fetch('/api/record/sessions');
                const data = await response.json();

                if (data.ok) {
                    availableSessions = data.sessions;
                    const select = document.getElementById('sessionSelect');
                    select.innerHTML = '<option value="">Select session to load...</option>';

                    availableSessions.forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.filename;
                        option.textContent = `${session.session_name} (${session.duration?.toFixed(1)}s, ${session.sample_count} samples)`;
                        select.appendChild(option);
                    });

                    showStatus('sessionStatus', `Found ${data.count} available sessions`, 'success');
                } else {
                    showStatus('sessionStatus', 'Failed to load available sessions', 'error');
                }
            } catch (error) {
                showStatus('sessionStatus', `Error: ${error.message}`, 'error');
            }
        }

        // Load selected session into analytics
        async function loadSelectedSession() {
            const select = document.getElementById('sessionSelect');
            const filename = select.value;

            if (!filename) {
                showStatus('sessionStatus', 'Please select a session', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/analytics/sessions/load?filename=${encodeURIComponent(filename)}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.ok) {
                    showStatus('sessionStatus', data.message, 'success');
                    await updateLoadedSessions();
                    updateSessionSelectors();
                } else {
                    showStatus('sessionStatus', data.message, 'error');
                }
            } catch (error) {
                showStatus('sessionStatus', `Error: ${error.message}`, 'error');
            }
        }

        // Update loaded sessions display
        async function updateLoadedSessions() {
            try {
                const response = await fetch('/api/analytics/sessions');
                const data = await response.json();

                if (data.ok) {
                    loadedSessions = data.sessions;

                    // Update loaded sessions list
                    const listDiv = document.getElementById('loadedSessionsList');
                    if (loadedSessions.length > 0) {
                        listDiv.innerHTML = '<h3 style="margin-top: 20px; color: #00ffff;">Loaded Sessions:</h3>';
                        loadedSessions.forEach(session => {
                            const div = document.createElement('div');
                            div.className = 'session-item';
                            div.innerHTML = `
                                <strong>${session.session_id}</strong> -
                                ${session.duration.toFixed(1)}s, ${session.sample_count} samples
                                <br>
                                <small>ICI: ${session.mean_ici.toFixed(3)}, Phi: ${session.mean_phi.toFixed(3)}</small>
                            `;
                            listDiv.appendChild(div);
                        });
                    } else {
                        listDiv.innerHTML = '<p style="color: #888;">No sessions loaded</p>';
                    }

                    // Update session statistics table
                    const statsDiv = document.getElementById('sessionStats');
                    if (loadedSessions.length > 0) {
                        let tableHTML = '<table><thead><tr><th>Session ID</th><th>Duration</th><th>Samples</th><th>Mean ICI</th><th>Mean Coherence</th><th>Mean Phi</th></tr></thead><tbody>';

                        loadedSessions.forEach(session => {
                            tableHTML += `
                                <tr>
                                    <td>${session.session_id}</td>
                                    <td>${session.duration.toFixed(1)}s</td>
                                    <td>${session.sample_count}</td>
                                    <td class="metric-value">${session.mean_ici.toFixed(3)}</td>
                                    <td class="metric-value">${session.mean_coherence.toFixed(3)}</td>
                                    <td class="metric-value">${session.mean_phi.toFixed(3)}</td>
                                </tr>
                            `;
                        });

                        tableHTML += '</tbody></table>';
                        statsDiv.innerHTML = tableHTML;
                    } else {
                        statsDiv.innerHTML = '<p class="loading">No sessions loaded</p>';
                    }

                    // Update system status
                    document.getElementById('loadedCount').textContent = data.count;
                    document.getElementById('totalSamples').textContent = data.memory_usage.total_samples.toLocaleString();
                    document.getElementById('memoryUsage').textContent = data.memory_usage.estimated_mb.toFixed(2);

                    const sc001Pass = data.memory_usage.estimated_mb <= 1024;
                    const sc001Status = document.getElementById('sc001Status');
                    sc001Status.textContent = sc001Pass ? 'PASS' : 'FAIL';
                    sc001Status.className = 'stat-value ' + (sc001Pass ? 'positive' : 'negative');
                }
            } catch (error) {
                console.error('Error updating loaded sessions:', error);
            }
        }

        // Update session selectors for comparison
        function updateSessionSelectors() {
            const sessionA = document.getElementById('sessionA');
            const sessionB = document.getElementById('sessionB');

            [sessionA, sessionB].forEach(select => {
                select.innerHTML = '<option value="">Select session...</option>';
                loadedSessions.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.session_id;
                    option.textContent = session.session_id;
                    select.appendChild(option);
                });
            });
        }

        // Compare two sessions
        async function compareSessions() {
            const sessionAId = document.getElementById('sessionA').value;
            const sessionBId = document.getElementById('sessionB').value;

            if (!sessionAId || !sessionBId) {
                showStatus('comparisonResults', 'Please select two sessions to compare', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/analytics/compare?session_a_id=${encodeURIComponent(sessionAId)}&session_b_id=${encodeURIComponent(sessionBId)}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.ok) {
                    const comp = data.comparison;
                    const resultsDiv = document.getElementById('comparisonResults');

                    resultsDiv.innerHTML = `
                        <div class="comparison-grid">
                            <div>
                                <h3 style="color: #00ffff; margin-bottom: 10px;">Delta Metrics</h3>
                                <table>
                                    <tr><th>Metric</th><th>Delta (B - A)</th></tr>
                                    <tr><td>ICI</td><td class="${comp.deltas.ici >= 0 ? 'positive' : 'negative'}">${comp.deltas.ici.toFixed(4)}</td></tr>
                                    <tr><td>Coherence</td><td class="${comp.deltas.coherence >= 0 ? 'positive' : 'negative'}">${comp.deltas.coherence.toFixed(4)}</td></tr>
                                    <tr><td>Criticality</td><td class="${comp.deltas.criticality >= 0 ? 'positive' : 'negative'}">${comp.deltas.criticality.toFixed(4)}</td></tr>
                                    <tr><td>Phi</td><td class="${comp.deltas.phi >= 0 ? 'positive' : 'negative'}">${comp.deltas.phi.toFixed(4)}</td></tr>
                                </table>
                            </div>
                            <div>
                                <h3 style="color: #00ffff; margin-bottom: 10px;">Correlations</h3>
                                <table>
                                    <tr><th>Metric</th><th>Correlation</th></tr>
                                    <tr><td>ICI</td><td class="${getCorrelationClass(comp.correlations.ici)}">${comp.correlations.ici.toFixed(3)}</td></tr>
                                    <tr><td>Coherence</td><td class="${getCorrelationClass(comp.correlations.coherence)}">${comp.correlations.coherence.toFixed(3)}</td></tr>
                                    <tr><td>Criticality</td><td class="${getCorrelationClass(comp.correlations.criticality)}">${comp.correlations.criticality.toFixed(3)}</td></tr>
                                    <tr><td>Phi</td><td class="${getCorrelationClass(comp.correlations.phi)}">${comp.correlations.phi.toFixed(3)}</td></tr>
                                </table>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <h3 style="color: #00ffff; margin-bottom: 10px;">Statistical Significance</h3>
                            <table>
                                <tr><th>Test</th><th>p-value</th><th>Significant?</th></tr>
                                <tr>
                                    <td>ICI t-test</td>
                                    <td>${comp.statistical_significance.ici_ttest_pvalue.toFixed(6)}</td>
                                    <td class="${comp.statistical_significance.ici_ttest_pvalue < 0.05 ? 'positive' : ''}">${comp.statistical_significance.ici_ttest_pvalue < 0.05 ? 'YES' : 'NO'}</td>
                                </tr>
                                <tr>
                                    <td>Coherence t-test</td>
                                    <td>${comp.statistical_significance.coherence_ttest_pvalue.toFixed(6)}</td>
                                    <td class="${comp.statistical_significance.coherence_ttest_pvalue < 0.05 ? 'positive' : ''}">${comp.statistical_significance.coherence_ttest_pvalue < 0.05 ? 'YES' : 'NO'}</td>
                                </tr>
                            </table>
                        </div>
                    `;
                } else {
                    showStatus('comparisonResults', data.message, 'error');
                }
            } catch (error) {
                showStatus('comparisonResults', `Error: ${error.message}`, 'error');
            }
        }

        // Load correlation matrix
        async function loadCorrelationMatrix() {
            const metric = document.getElementById('metricSelect').value;

            try {
                const response = await fetch(`/api/analytics/correlations?metric=${metric}`);
                const data = await response.json();

                if (data.ok) {
                    showStatus('correlationStatus', `Loaded ${metric} correlation matrix (${data.session_count}x${data.session_count})`, 'success');
                    drawHeatmap(data.matrix, data.session_ids, metric);
                } else {
                    showStatus('correlationStatus', data.message, 'error');
                }
            } catch (error) {
                showStatus('correlationStatus', `Error: ${error.message}`, 'error');
            }
        }

        // Load all correlations
        async function loadAllCorrelations() {
            try {
                const response = await fetch('/api/analytics/correlations/all');
                const data = await response.json();

                if (data.ok) {
                    showStatus('correlationStatus', `Loaded ${data.metrics_count} correlation matrices`, 'success');

                    // Display first available metric
                    const firstMetric = Object.keys(data.correlations)[0];
                    if (firstMetric) {
                        const corrData = data.correlations[firstMetric];
                        drawHeatmap(corrData.matrix, corrData.session_ids, firstMetric);
                    }
                } else {
                    showStatus('correlationStatus', data.message, 'error');
                }
            } catch (error) {
                showStatus('correlationStatus', `Error: ${error.message}`, 'error');
            }
        }

        // Draw correlation heatmap
        function drawHeatmap(matrix, sessionIds, metric) {
            const canvas = document.getElementById('heatmapCanvas');
            const ctx = canvas.getContext('2d');
            const size = matrix.length;

            if (size === 0) return;

            const cellSize = 500 / size;
            const labelSize = 100;

            // Clear canvas
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw cells
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const value = matrix[i][j];

                    // Color gradient from red (-1) to yellow (0) to green (1)
                    let color;
                    if (value >= 0) {
                        const intensity = Math.floor(value * 255);
                        color = `rgb(${255 - intensity}, 255, ${255 - intensity})`;
                    } else {
                        const intensity = Math.floor(Math.abs(value) * 255);
                        color = `rgb(255, ${255 - intensity}, ${255 - intensity})`;
                    }

                    ctx.fillStyle = color;
                    ctx.fillRect(labelSize + j * cellSize, i * cellSize, cellSize, cellSize);

                    // Draw value
                    ctx.fillStyle = '#000';
                    ctx.font = `${Math.max(10, cellSize / 3)}px Monaco`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(
                        value.toFixed(2),
                        labelSize + j * cellSize + cellSize / 2,
                        i * cellSize + cellSize / 2
                    );

                    // Draw border
                    ctx.strokeStyle = '#333';
                    ctx.strokeRect(labelSize + j * cellSize, i * cellSize, cellSize, cellSize);
                }
            }

            // Draw labels
            ctx.fillStyle = '#00ff00';
            ctx.font = '12px Monaco';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';

            for (let i = 0; i < size; i++) {
                const label = sessionIds[i].substring(0, 12);
                ctx.fillText(label, labelSize - 10, i * cellSize + cellSize / 2);
            }

            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.save();
            for (let j = 0; j < size; j++) {
                const label = sessionIds[j].substring(0, 12);
                ctx.translate(labelSize + j * cellSize + cellSize / 2, size * cellSize + 20);
                ctx.rotate(-Math.PI / 4);
                ctx.fillText(label, 0, 0);
                ctx.restore();
                ctx.save();
            }
            ctx.restore();

            // Draw title
            ctx.fillStyle = '#00ffff';
            ctx.font = 'bold 16px Monaco';
            ctx.textAlign = 'center';
            ctx.fillText(`${metric.toUpperCase()} Correlation Matrix`, canvas.width / 2, size * cellSize + 80);
        }

        // Helper functions
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function getCorrelationClass(value) {
            if (Math.abs(value) >= 0.7) return 'correlation-high';
            if (Math.abs(value) >= 0.4) return 'correlation-medium';
            return 'correlation-low';
        }
    </script>
</body>
</html>
