<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi Adaptive Control - Soundlab</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        h2 { margin-bottom: 20px; font-size: 1.5em; }
        button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: rgba(76, 175, 80, 0.6);
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        button:hover { background: rgba(76, 175, 80, 0.8); transform: translateY(-2px); }
        button:disabled { background: rgba(128, 128, 128, 0.4); cursor: not-allowed; }
        button.danger { background: rgba(244, 67, 54, 0.6); }
        button.danger:hover { background: rgba(244, 67, 54, 0.8); }
        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .metric {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .metric-label { font-size: 0.9em; opacity: 0.8; }
        .status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: 600; }
        .status.active { background: rgba(76, 175, 80, 0.6); }
        .status.inactive { background: rgba(244, 67, 54, 0.6); }
        .status.warning { background: rgba(255, 152, 0, 0.6); }
        #iciChart, #phiChart { width: 100%; height: 200px; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Phi Adaptive Control Dashboard</h1>

        <!-- Adaptive Control Status -->
        <div class="card">
            <h2>Adaptive Control <span class="status inactive" id="adaptiveStatus">DISABLED</span></h2>
            <div class="controls">
                <select id="modeSelect">
                    <option value="reactive">Reactive Mode</option>
                    <option value="predictive">Predictive Mode</option>
                    <option value="learning">Learning Mode</option>
                </select>
                <button id="enableAdaptive">Enable Adaptive Control</button>
                <button id="disableAdaptive" disabled>Disable Adaptive Control</button>
                <button id="triggerLearning">Trigger Learning</button>
            </div>
        </div>

        <!-- Manual Override -->
        <div class="card">
            <h2>Manual Override <span class="status inactive" id="overrideStatus">OFF</span></h2>
            <div class="controls">
                <button id="enableOverride">Enable Manual Override</button>
                <button id="disableOverride" disabled>Disable Manual Override</button>
            </div>
            <p style="margin-top:10px; opacity:0.8; font-size:0.9em;">
                Manual override pauses adaptive control and freezes Phi values.
            </p>
        </div>

        <!-- ICI Stability Monitor (SC-001) -->
        <div class="card">
            <h2>ICI Stability (SC-001: Target 0.5 ± 0.05)</h2>
            <div class="metrics-grid">
                <div class="metric">
                    <div class="metric-label">Current ICI</div>
                    <div class="metric-value" id="currentICI">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">ICI Error</div>
                    <div class="metric-value" id="iciError">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Stable Time</div>
                    <div class="metric-value" id="stableTime">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Status</div>
                    <div class="metric-value status inactive" id="stabilityStatus" style="font-size:1em; margin:15px 0;">UNSTABLE</div>
                </div>
            </div>
            <canvas id="iciChart"></canvas>
        </div>

        <!-- Phi Adaptation Status -->
        <div class="card">
            <h2>Phi Adaptation</h2>
            <div class="metrics-grid">
                <div class="metric">
                    <div class="metric-label">Current Phi</div>
                    <div class="metric-value" id="currentPhi">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Predicted Phi</div>
                    <div class="metric-value" id="predictedPhi">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Phi Adjustment</div>
                    <div class="metric-value" id="phiAdjustment">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Update Count</div>
                    <div class="metric-value" id="updateCount">--</div>
                </div>
            </div>
            <canvas id="phiChart"></canvas>
        </div>

        <!-- Performance Metrics (SC-002) -->
        <div class="card">
            <h2>Performance (SC-002: Latency ≤ 200 ms)</h2>
            <div class="metrics-grid">
                <div class="metric">
                    <div class="metric-label">Avg Update Latency</div>
                    <div class="metric-value" id="avgLatency">--</div>
                    <div class="metric-label" id="latencyStatus" style="color:#4CAF50;">OK</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Mode</div>
                    <div class="metric-value" id="currentMode" style="font-size:1.2em;">--</div>
                </div>
            </div>
        </div>

        <!-- Session Management -->
        <div class="card">
            <h2>Session Management</h2>
            <div class="controls">
                <input type="text" id="sessionPath" placeholder="session_name.json" style="flex:1; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.2); color:#fff;">
                <button id="saveSession">Save Session</button>
                <button id="loadSession">Load Session</button>
            </div>
        </div>
    </div>

    <script>
        const elements = {
            adaptiveStatus: document.getElementById('adaptiveStatus'),
            enableAdaptive: document.getElementById('enableAdaptive'),
            disableAdaptive: document.getElementById('disableAdaptive'),
            modeSelect: document.getElementById('modeSelect'),
            triggerLearning: document.getElementById('triggerLearning'),
            overrideStatus: document.getElementById('overrideStatus'),
            enableOverride: document.getElementById('enableOverride'),
            disableOverride: document.getElementById('disableOverride'),
            currentICI: document.getElementById('currentICI'),
            iciError: document.getElementById('iciError'),
            stableTime: document.getElementById('stableTime'),
            stabilityStatus: document.getElementById('stabilityStatus'),
            currentPhi: document.getElementById('currentPhi'),
            predictedPhi: document.getElementById('predictedPhi'),
            phiAdjustment: document.getElementById('phiAdjustment'),
            updateCount: document.getElementById('updateCount'),
            avgLatency: document.getElementById('avgLatency'),
            latencyStatus: document.getElementById('latencyStatus'),
            currentMode: document.getElementById('currentMode'),
            sessionPath: document.getElementById('sessionPath'),
            saveSession: document.getElementById('saveSession'),
            loadSession: document.getElementById('loadSession'),
            iciChart: document.getElementById('iciChart'),
            phiChart: document.getElementById('phiChart')
        };

        // Chart setup
        const iciCtx = elements.iciChart.getContext('2d');
        const phiCtx = elements.phiChart.getContext('2d');
        const iciHistory = [];
        const phiHistory = [];
        const maxHistory = 100;

        function drawICIChart() {
            iciCtx.clearRect(0, 0, elements.iciChart.width, elements.iciChart.height);

            // Draw target zone (0.45-0.55)
            const targetMin = 0.45;
            const targetMax = 0.55;
            const chartHeight = elements.iciChart.height;

            iciCtx.fillStyle = 'rgba(76, 175, 80, 0.2)';
            const yMin = chartHeight - (targetMin * chartHeight);
            const yMax = chartHeight - (targetMax * chartHeight);
            iciCtx.fillRect(0, yMax, elements.iciChart.width, yMin - yMax);

            // Draw ICI line
            if (iciHistory.length > 1) {
                iciCtx.strokeStyle = '#2196F3';
                iciCtx.lineWidth = 2;
                iciCtx.beginPath();

                for (let i = 0; i < iciHistory.length; i++) {
                    const x = (i / maxHistory) * elements.iciChart.width;
                    const y = chartHeight - (iciHistory[i] * chartHeight);
                    if (i === 0) iciCtx.moveTo(x, y);
                    else iciCtx.lineTo(x, y);
                }
                iciCtx.stroke();
            }
        }

        function drawPhiChart() {
            phiCtx.clearRect(0, 0, elements.phiChart.width, elements.phiChart.height);

            if (phiHistory.length > 1) {
                phiCtx.strokeStyle = '#FF9800';
                phiCtx.lineWidth = 2;
                phiCtx.beginPath();

                const phiMin = 0.618;
                const phiMax = 1.618;
                const chartHeight = elements.phiChart.height;

                for (let i = 0; i < phiHistory.length; i++) {
                    const x = (i / maxHistory) * elements.phiChart.width;
                    const normalized = (phiHistory[i] - phiMin) / (phiMax - phiMin);
                    const y = chartHeight - (normalized * chartHeight);
                    if (i === 0) phiCtx.moveTo(x, y);
                    else phiCtx.lineTo(x, y);
                }
                phiCtx.stroke();
            }
        }

        // Enable adaptive control
        elements.enableAdaptive.addEventListener('click', async () => {
            const mode = elements.modeSelect.value;
            const response = await fetch(`/api/adaptive-control/enable?mode=${mode}`, { method: 'POST' });
            const data = await response.json();

            if (data.ok) {
                elements.adaptiveStatus.textContent = 'ACTIVE';
                elements.adaptiveStatus.className = 'status active';
                elements.enableAdaptive.disabled = true;
                elements.disableAdaptive.disabled = false;
                alert(`Adaptive control enabled in ${mode} mode`);
            } else {
                alert('Failed to enable adaptive control: ' + data.message);
            }
        });

        // Disable adaptive control
        elements.disableAdaptive.addEventListener('click', async () => {
            const response = await fetch('/api/adaptive-control/disable', { method: 'POST' });
            const data = await response.json();

            if (data.ok) {
                elements.adaptiveStatus.textContent = 'DISABLED';
                elements.adaptiveStatus.className = 'status inactive';
                elements.enableAdaptive.disabled = false;
                elements.disableAdaptive.disabled = true;
            }
        });

        // Enable manual override
        elements.enableOverride.addEventListener('click', async () => {
            const response = await fetch('/api/adaptive-control/manual-override?enabled=true', { method: 'POST' });
            const data = await response.json();

            if (data.ok) {
                elements.overrideStatus.textContent = 'ON';
                elements.overrideStatus.className = 'status warning';
                elements.enableOverride.disabled = true;
                elements.disableOverride.disabled = false;
            }
        });

        // Disable manual override
        elements.disableOverride.addEventListener('click', async () => {
            const response = await fetch('/api/adaptive-control/manual-override?enabled=false', { method: 'POST' });
            const data = await response.json();

            if (data.ok) {
                elements.overrideStatus.textContent = 'OFF';
                elements.overrideStatus.className = 'status inactive';
                elements.enableOverride.disabled = false;
                elements.disableOverride.disabled = true;
            }
        });

        // Trigger learning
        elements.triggerLearning.addEventListener('click', async () => {
            const response = await fetch('/api/adaptive-control/trigger-learning', { method: 'POST' });
            const data = await response.json();

            alert(data.message);
        });

        // Save session
        elements.saveSession.addEventListener('click', async () => {
            const filepath = elements.sessionPath.value || 'adaptive_session.json';
            const response = await fetch(`/api/adaptive-control/save-session?filepath=${encodeURIComponent(filepath)}`, { method: 'POST' });
            const data = await response.json();

            alert(data.message);
        });

        // Load session
        elements.loadSession.addEventListener('click', async () => {
            const filepath = elements.sessionPath.value || 'adaptive_session.json';
            const response = await fetch(`/api/adaptive-control/load-session?filepath=${encodeURIComponent(filepath)}`, { method: 'POST' });
            const data = await response.json();

            alert(data.message);
        });

        // Update status
        async function updateStatus() {
            try {
                const response = await fetch('/api/adaptive-control/status');
                const data = await response.json();

                if (!data.ok || !data.adaptive_enabled || !data.status) {
                    return;
                }

                const status = data.status;

                // Update ICI metrics
                elements.currentICI.textContent = status.current_ici.toFixed(3);
                elements.iciError.textContent = (status.ici_error >= 0 ? '+' : '') + status.ici_error.toFixed(3);
                elements.stableTime.textContent = status.ici_stable_time_s.toFixed(1) + 's';

                // Check stability (SC-001)
                const isStable = Math.abs(status.ici_error) <= 0.05;
                if (isStable) {
                    elements.stabilityStatus.textContent = 'STABLE';
                    elements.stabilityStatus.className = 'metric-value status active';
                } else {
                    elements.stabilityStatus.textContent = 'UNSTABLE';
                    elements.stabilityStatus.className = 'metric-value status warning';
                }

                // Update Phi metrics
                elements.currentPhi.textContent = status.current_phi.toFixed(3);
                elements.predictedPhi.textContent = status.predicted_phi.toFixed(3);
                elements.phiAdjustment.textContent = (status.phi_adjustment >= 0 ? '+' : '') + status.phi_adjustment.toFixed(3);
                elements.updateCount.textContent = status.update_count;

                // Update performance (SC-002)
                elements.avgLatency.textContent = status.avg_update_latency_ms.toFixed(1) + ' ms';
                const latencyOk = status.avg_update_latency_ms <= 200;
                elements.latencyStatus.textContent = latencyOk ? 'OK' : 'SLOW';
                elements.latencyStatus.style.color = latencyOk ? '#4CAF50' : '#F44336';

                // Update mode
                elements.currentMode.textContent = status.mode;

                // Update override status
                if (status.manual_override_active) {
                    elements.overrideStatus.textContent = 'ON';
                    elements.overrideStatus.className = 'status warning';
                    elements.enableOverride.disabled = true;
                    elements.disableOverride.disabled = false;
                } else {
                    elements.overrideStatus.textContent = 'OFF';
                    elements.overrideStatus.className = 'status inactive';
                    elements.enableOverride.disabled = false;
                    elements.disableOverride.disabled = true;
                }

                // Update charts
                iciHistory.push(status.current_ici);
                if (iciHistory.length > maxHistory) iciHistory.shift();
                drawICIChart();

                phiHistory.push(status.current_phi);
                if (phiHistory.length > maxHistory) phiHistory.shift();
                drawPhiChart();

            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        // Poll status at 10 Hz
        setInterval(updateStatus, 100);

        // Initial load
        (async () => {
            const statusResp = await fetch('/api/adaptive-control/status');
            const statusData = await statusResp.json();

            if (statusData.ok && statusData.adaptive_enabled) {
                elements.adaptiveStatus.textContent = 'ACTIVE';
                elements.adaptiveStatus.className = 'status active';
                elements.enableAdaptive.disabled = true;
                elements.disableAdaptive.disabled = false;
            }
        })();

        // Resize canvases
        function resizeCanvases() {
            elements.iciChart.width = elements.iciChart.offsetWidth;
            elements.iciChart.height = 200;
            elements.phiChart.width = elements.phiChart.offsetWidth;
            elements.phiChart.height = 200;
        }
        resizeCanvases();
        window.addEventListener('resize', resizeCanvases);
    </script>
</body>
</html>
